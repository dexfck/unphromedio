name: Android Build & Sign v1

on:
    push:
        branches: ["main"]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            # 1. Bajar código
            - name: Checkout Code
              uses: actions/checkout@v4

            # 2. Configurar Java
            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"
                  cache: "gradle"

            # 3. Restaurar Keystore desde Secretos
            - name: Decode Keystore
              env:
                  ENCODED_STRING: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
              run: |
                  echo $ENCODED_STRING | base64 --decode > app/release-key.jks

            # 4. Permisos de ejecución
            - name: Make gradlew executable
              run: chmod +x gradlew

            # 5. Compilar APK Firmado
            - name: Build Signed APK
              env:
                  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                  KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
                  KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
              run: |
                  ./gradlew assembleRelease \
                    -Pandroid.injected.signing.store.file=$(pwd)/app/release-key.jks \
                    -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
                    -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
                    -Pandroid.injected.signing.key.password=$KEY_PASSWORD

            # 6. Guardar APK como descargable
            - name: Upload APK
              uses: actions/upload-artifact@v4
              with:
                  name: app-release
                  path: app/build/outputs/apk/release/*.apk
